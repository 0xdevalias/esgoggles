<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="jquery.js"></script>
    <script src="esprima.js"></script>
    <script src="estraverse.js"></script>
    <script src="almond.js"></script>
	<script>
	define('estraverse', estraverse);
	</script>
    <script src="escope.js"></script>
    <script src="findVariables.js"></script>
    <script src="raw_openwebglobe.js"></script>
	<link rel='stylesheet' href='reset.css'/>
	<link rel='stylesheet' href='uml.css'/>
	<link rel='stylesheet' href='style2.css'/>
</head>
<body>
<script>
var escope = require('escope')

function cleanComment(str) {
	var cleaned = [],
		symbols = '[/*#-]+',
		junk = new RegExp('^\\s*' + symbols + '|' + symbols + '\\s*$')
	$.each(str.split('\n'), function(line, lstr) {
		var s = lstr.replace(junk, '')
		if ($.trim(s))
			cleaned.push(s)
	})
	return cleaned.join('\n')
}

function ast$(raw, ast) {
	var $ast = $('<ast>'),
		spaces = '    ',
		indent = '\n' + spaces,
		doubleIndent = '\n' + spaces + spaces,
		header = '\n------------------------',
		extractQueue = []

	function processExtractQueue() {
		if (extractQueue.length)
			extractComments(extractQueue.shift(), processExtractQueue)
	}

	// Need to optimize this, super slow..
	function extractComments($code, next) {
		var t0 = new Date().valueOf()
		for (var i=0; i < ast.comments.length; ) {
			var comment = ast.comments[i],
				text

			if (comment.range[0] >= $code.data('range0') && comment.range[1] <= $code.data('range1')) {
				ast.comments.splice(i,1)

				if ($code[0].childNodes.length === 1) {
					text = $.trim(raw.substring($code.data('range0'), comment.range[0]))
					if (text.length) {
						$('<code>')
							.text(text)
							.data('range0', $code.data('range0'))
							.data('range1', comment.range[0])
							.insertBefore($code)
					}

					$('<comment>')
						.addClass(comment.type)
						.html(cleanComment(raw.substring(comment.range[0], comment.range[1])))
						.insertBefore($code)

					text = $.trim(raw.substring(comment.range[1], $code.data('range1')))
					if (text.length) {
						$code
							.text(text)
							.data('range0', comment.range[1])
							.data('range1', $code.data('range1'))
					} else {
						$code.remove()
						break;
					}
				} else {
					console.log('assertion failed')
				}
			} else {
				i++
			}
		}
		var t1 = new Date().valueOf()
		//console.log('extract comment dt', t1-t0)

		setTimeout(next,0)
	}

	var x = 0
	function recurse(n, $parent, classes, keySummary) {
		var $es = $('<es>')
			.appendTo($parent)
			.addClass(n.type)
			.addClass(classes)
			.attr({
				title: n.type
			})
			.data('node', n)

		if (n.type === 'Identifier') {
			$es.attr({
				title: $es.attr('title') + indent + '.name = ' + n.name,
				name: n.name
			})
		}

		$es.data('preceedingRawCode', raw.substring(x, n.range[0]))

		var $preceedingRawCode = $('<code>')
			.text($es.data('preceedingRawCode'))
			.data('range0', x)
			.data('range1', n.range[0])
			.insertBefore($es)

		extractQueue.push($preceedingRawCode)

		x = n.range[0]

		$.each(n, function(k,v) {
			var isChild = estraverse.VisitorKeys[n.type].indexOf(k) >= 0,
				child = isChild ? n[k] : null

			if ($.isArray(child)) {
				$.each(child, function(i) {
					var classes = (k + '_') + ' ' + ('_' + i),
						keySummary = (n.type + indent + '.' + k + '[' + i + ']')
					recurse(this, $es, classes, keySummary)
				})
			} else if (child) {
				var classes = k,
					keySummary = (n.type + indent + '.' + k)
				recurse(child, $es, classes, keySummary)
			} else {
				if (typeof v === 'boolean') {
					$es.addClass(k + '-' + v.toString())
					$es.attr('title', $es.attr('title') + indent + '.' + k + ' = ' + v.toString())
				}
			}

			$es.data(k, v)
		})

		if (keySummary)
			$es.attr('title', $es.attr('title') + header + '\n' + keySummary)

		$es.data('trailingRawCode', raw.substring(x, n.range[1]))

		var $trailingRawCode = $('<code>')
			.text($es.data('trailingRawCode'))
			.data('range0', x)
			.data('range1', n.range[1])
			.appendTo($es)

		extractQueue.push($trailingRawCode)

		x = n.range[1]
	}

	recurse(ast, $ast)

	processExtractQueue()

	return $ast
}

function codeFrom$($ast) {
	var code = []
	
	function recurse($es) {
		code.push($es.data('preceedingRawCode'))

		if (!$es.hasClass('marked-for-removal')) {
			$es.find('> es').each(function() {
				recurse($(this))
			})

			code.push($es.data('trailingRawCode'))
		}
	}

	recurse($ast)

	return code.join('')
}

markFunctionCalls = (function() {
	function predicateFor(name) {
		return name === '*' || !name ? '[name]' : '[name=' + name + ']'
	}
	function adjacencyFor(name) {
		return !name ? '' : '>'
	}

	return function($ast, marker, fnames) {
		$.each(fnames, function(_, path) {
			console.log('-----------------')
			console.log(path)
			var dir = path.split('.'),
				fname = dir.pop(),
				calleeObject = dir.pop(),
				calleeObjectSelector,
				$calleeObject

			console.log(calleeObject)
			if (typeof calleeObject !== 'undefined') {
				if (dir.length === 0) {
					calleeObjectSelector = 'es.CallExpression > es.MemberExpression.callee ' + adjacencyFor(calleeObject) + ' es.Identifier.object' + predicateFor(calleeObject)
				} else {
					calleeObjectSelector = []
					$.each(dir, function(_, d) {
						console.log('d',d,adjacencyFor(d))
						calleeObjectSelector.push(adjacencyFor(d) + ' es.MemberExpression.object > es.Identifier.object' + predicateFor(d))
					})
					calleeObjectSelector = 'es.CallExpression > es.MemberExpression.callee ' + calleeObjectSelector.join(' ') + ' ~ es.Identifier.property' + predicateFor(calleeObject)
				}

				console.log(calleeObjectSelector)
				$ast.find(calleeObjectSelector).each(function() {
					$(this)
						.closest('es.CallExpression')
						.find('> es.MemberExpression.callee > es.Identifier.property' + predicateFor(fname))
						.closest('es.CallExpression').addClass(marker)
				})
			} else {
				calleeObjectSelector = 'es.CallExpression > es.Identifier.callee' + predicateFor(fname)
				$ast.find(calleeObjectSelector).each(function() {
					$(this)
						.closest('es.CallExpression').addClass(marker)
				})
			}
		})
	}
})()

function markConsoleCallsForRemoval($ast) {
	markFunctionCalls($ast, 'marked-for-removal', ['window.console.*', 'console.*'])
}

function Benchmark() {
	this.results = []
}
Benchmark.prototype.report = function() {
	$.each(this.results, function(_, result) {
		console.log(result.name, result.duration, 'ms')
	})
	return this
}
Benchmark.prototype.time = function(name, f) {
	var t0 = new Date().valueOf()
	f()
	var t1 = new Date().valueOf()
	this.results.push({
		name: name,
		duration: t1 - t0
	})
	return this
}

;(function() {
	var raw = raw_openwebglobe.toString().replace(/^function raw_openwebglobe\(\)\{|\}$/g,''),
		benchmark = new Benchmark(),
		ast,
		$ast

	benchmark
		.time('ast', function() {
			ast = esprima.parse(raw, {
				range: true,
				loc: false,
				comment: true,
				tolerant: false
			})
		})
		.time('ast$', function() {
			$ast = ast$(raw, ast)
		})
		.time('findVariables', function() {
			findVariables($ast)
		})
		.report()

	//markConsoleCallsForRemoval($ast)
	//markFunctionCalls($ast, 'highlighted', ['log'])

	$ast.appendTo('body')
})();

$('<hr/>').appendTo('body');

</script>
</body>
</html>
